@page "/"
@using MediatR
@using TrackYourDay.Core;
@using TrackYourDay.Core.ApplicationTrackers.Breaks
@using TrackYourDay.Core.Insights.Workdays
@using TrackYourDay.Core.Settings
@using TrackYourDay.Core.SystemTrackers
@using TrackYourDay.Core.Persistence
@using TrackYourDay.Core.Persistence.Specifications
@using TrackYourDay.Web.Components

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="pa-4">
    <MudStack Spacing="4">
        <!-- Header with controls -->
        <MudPaper Elevation="0" Class="d-flex align-center gap-4 pa-3" Style="border-radius: 12px;">
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" 
                          Color="Color.Primary" 
                          OnClick="Refresh" 
                          Size="Size.Large" />
            <MudDatePicker Label="Select Date" 
                          Date="selectedDate" 
                          DateChanged="OnDateChanged" 
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense" />
            <MudSpacer />
            <OperationalBarComponent />
        </MudPaper>

        <!-- External Work Items -->
        <ExternalArtifactsComponent />

        <!-- Workday Overview -->
        <MudExpansionPanels MultiExpansion="true">
    <MudExpansionPanel Text="Workday Progress" IsInitiallyExpanded="true">
        @if (IsToday())
        {
            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                <MudText Typo="Typo.h6">Estimated end: @estimatedEndOfWorkDay.ToShortTimeString()</MudText>
            </MudAlert>
        }
        else
        {
            <MudAlert Severity="Severity.Normal" Dense="true" Class="mb-4">
                <MudText Typo="Typo.h6">Historical Data: @selectedDate?.ToString("D")</MudText>
            </MudAlert>
        }
        <MudGrid Justify="Justify.Center" Spacing="3">
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="pa-4 text-center" Style="border-radius: 12px;" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">Time Left</MudText>
                    <MudChart ChartType="ChartType.Donut" Width="200px" Height="200px" InputData="@worktimeLeftDataChart" InputLabels="@worktimeLeftLabelsChart">
                        <CustomGraphics>
                            <text class="donut-inner-text" x="47%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#616161" font-family="Helvetica" font-size="5">
                                @(workday.TimeLeftToWorkActively.Hours)h @(workday.TimeLeftToWorkActively.Minutes)m
                            </text>
                        </CustomGraphics>
                    </MudChart>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="pa-4 text-center" Style="border-radius: 12px;" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">Breaks</MudText>
                    <MudChart ChartType="ChartType.Donut" Width="200px" Height="200px" InputData="@breaksLeftDataChart" InputLabels="@breaksLeftLabelsChart">
                        <CustomGraphics>
                            <text class="donut-inner-text" x="47%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#616161" font-family="Helvetica" font-size="5">
                                @(workday.BreakTimeLeft.Hours)h @(workday.BreakTimeLeft.Minutes)m
                            </text>
                        </CustomGraphics>
                    </MudChart>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudPaper Class="pa-4 text-center" Style="border-radius: 12px;" Elevation="2">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mb-2">Overhours</MudText>
                    <MudChart ChartType="ChartType.Donut" Width="200px" Height="200px" InputData="@overhoursDataChart" InputLabels="@overhoursLabelsChart">
                        <CustomGraphics>
                            <text class="donut-inner-text" x="47%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#616161" font-family="Helvetica" font-size="5">
                                @(workday.OverhoursTime.Hours)h @(workday.OverhoursTime.Minutes)m
                            </text>
                        </CustomGraphics>
                    </MudChart>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudExpansionPanel>
</MudExpansionPanels>
    </MudStack>
</MudContainer>

@code {
    [Inject]
    private IWorkdaySettingsService workdaySettingsService { get; set; }
    [Inject]
    private IHistoricalDataRepository<EndedActivity> activityRepository { get; set; }
    [Inject]
    private IHistoricalDataRepository<EndedBreak> breakRepository { get; set; }
    [Inject]
    public required IMediator Mediator { get; set; }
    [Inject]
    private IClock clock { get; set; }

    private Workday workday;
    private WorkdayDefinition workdayDefinition;
    private DateTime? selectedDate;

    private DateTime estimatedEndOfWorkDay;

    private double[] worktimeLeftDataChart = { 0, 0 };
    private string[] worktimeLeftLabelsChart = { "Time to Work", "Worked Time" };

    private double[] overhoursDataChart = { 0, 120 };
    private string[] overhoursLabelsChart = { "Overhours done", "Max overhours" };

    private double[] breaksLeftDataChart = { 0, 0 };
    private string[] breaksLeftLabelsChart = { "Breaks left", "Breaks taken" };

    protected override void OnInitialized()
    {
        selectedDate = clock.Now.Date;
        this.Refresh();
    }

    private void OnDateChanged(DateTime? date)
    {
        selectedDate = date ?? DateTime.Now;
        Refresh();
    }

    private void Refresh()
    {
        if (selectedDate == null) return;

        var dateOnly = DateOnly.FromDateTime(selectedDate.Value);
        this.workdayDefinition = this.workdaySettingsService.GetWorkdayDefinition();
        
        var activities = this.activityRepository.Find(new ActivityByDateSpecification(dateOnly));
        var breakSpec = new AndSpecification<EndedBreak>(
            new BreakByDateSpecification(dateOnly),
            new NonRevokedBreaksSpecification());
        var breaks = this.breakRepository.Find(breakSpec);
        
        this.workday = Workday.CreateBasedOn(this.workdayDefinition, activities, breaks);

        // Only calculate estimated end time for today
        if (IsToday())
        {
            this.estimatedEndOfWorkDay = clock.Now + workday.OverallTimeLeftToWork;
        }

        worktimeLeftDataChart[0] = this.workday.TimeLeftToWorkActively.TotalMinutes;
        worktimeLeftDataChart[1] = this.workday.TimeAlreadyActivelyWorkded.TotalMinutes;

        overhoursDataChart[0] = this.workday.OverhoursTime.TotalMinutes;

        breaksLeftDataChart[0] = this.workday.BreakTimeLeft.TotalMinutes;
        breaksLeftDataChart[1] = this.workday.ValidBreakTimeUsed.TotalMinutes;
    }
    
    private bool IsToday()
    {
        return selectedDate.HasValue && selectedDate.Value.Date == clock.Now.Date;
    }
}