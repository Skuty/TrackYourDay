@page "/MeetingEndConfirmation/{MeetingGuidString}"
@implements IDisposable

@using TrackYourDay.Core.ApplicationTrackers.MsTeams
@using TrackYourDay.Core.MAUIProxy
@using TrackYourDay.Web.Services
@using MediatR

@inject IMediator mediator
@inject IMsTeamsMeetingService meetingService
@inject IRecentMeetingsCache recentMeetingsCache
@inject TrackYourDay.Core.IClock clock

<MudContainer MaxWidth="MaxWidth.Small" Class="py-4">
    @if (pendingMeeting != null)
    {
        <MudPaper Class="pa-6" Elevation="3">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Warning">
                    Did this meeting end?
                </MudText>

                <MudStack Spacing="2">
                    <MudText Typo="Typo.body2">
                        <strong>Meeting:</strong> @pendingMeeting.Meeting.Title
                    </MudText>

                    <MudText Typo="Typo.body2">
                        <strong>Duration:</strong> @((int)pendingMeeting.Meeting.GetDuration(clock).TotalMinutes) minutes
                    </MudText>
                </MudStack>

                <MudTextField @bind-Value="customDescription"
                              Label="Description (optional)"
                              Placeholder="@pendingMeeting.Meeting.Title"
                              Variant="Variant.Outlined"
                              Lines="2"
                              Margin="Margin.Dense" />

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success" 
                               FullWidth="true" 
                               OnClick="ConfirmEnd"
                               Disabled="isProcessing">
                        Confirm
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true" 
                               OnClick="StillOngoing"
                               Disabled="isProcessing">
                        Still Ongoing
                    </MudButton>
                </MudStack>

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Dense="true">@errorMessage</MudAlert>
                }
            </MudStack>
        </MudPaper>
    }
    else
    {
        <MudAlert Severity="Severity.Warning">Meeting confirmation expired</MudAlert>
    }
</MudContainer>

@code {
    [Parameter]
    public string MeetingGuidString { get; set; } = string.Empty;

    [CascadingParameter(Name = "ParentMauiWindowId")]
    public Guid ParentMauiWindowId { get; set; }

    private PendingEndMeeting? pendingMeeting;
    private string? customDescription;
    private string errorMessage = string.Empty;
    private bool isProcessing;
    private bool _userResponded;
    private CancellationTokenSource _timeoutCts = new();

    protected override void OnInitialized()
    {
        if (Guid.TryParse(MeetingGuidString, out var meetingGuid))
        {
            pendingMeeting = recentMeetingsCache.GetPending(meetingGuid);
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && pendingMeeting != null)
        {
            _ = Task.Run(async () =>
            {
                try
                {
                    await Task.Delay(TimeSpan.FromMinutes(10), _timeoutCts.Token);
                    
                    await InvokeAsync(async () =>
                    {
                        if (!_userResponded)
                        {
                            await StillOngoing();
                        }
                    });
                }
                catch (TaskCanceledException)
                {
                    // User responded before timeout
                }
            });
        }
    }

    private async Task ConfirmEnd()
    {
        if (pendingMeeting == null || isProcessing)
            return;

        _userResponded = true;
        _timeoutCts.Cancel();
        isProcessing = true;
        errorMessage = string.Empty;

        try
        {
            await meetingService.ConfirmMeetingEndAsync(
                pendingMeeting.Meeting.Guid,
                customDescription
            );
            await CloseWindow();
        }
        catch (Exception)
        {
            errorMessage = "An error occurred while confirming the meeting end. Please try again.";
            isProcessing = false;
        }
    }

    private async Task StillOngoing()
    {
        if (pendingMeeting == null)
            return;

        _userResponded = true;
        _timeoutCts.Cancel();

        meetingService.CancelPendingEnd(pendingMeeting.Meeting.Guid);
        await CloseWindow();
    }

    private async Task CloseWindow()
    {
        await mediator.Send(new CloseWindowCommand(ParentMauiWindowId));
    }

    public void Dispose()
    {
        _timeoutCts?.Cancel();
        _timeoutCts?.Dispose();
    }
}
