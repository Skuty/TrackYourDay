@page "/MeetingEndConfirmation/{MeetingGuidString}"
@implements IDisposable

@using TrackYourDay.Core.ApplicationTrackers.MsTeams
@using TrackYourDay.Core.MAUIProxy
@using MediatR

@inject IMediator mediator
@inject MsTeamsMeetingTracker meetingService
@inject NavigationManager navigationManager

@if (!string.IsNullOrEmpty(meetingTitle))
{
    <div class="meeting-container">
        <!-- Header with status indicator -->
        <div class="meeting-header">
            <h3 class="meeting-header-title">Did this meeting end?</h3>
        </div>

        <!-- Scrollable content area -->
        <div class="meeting-content">
            <!-- Meeting Information -->
            <div class="meeting-info">
                <div class="meeting-info-row">
                    <span class="meeting-info-label">Meeting:</span>
                    <span class="meeting-info-value">@meetingTitle</span>
                </div>
                <div class="meeting-info-row">
                    <span class="meeting-info-label">Started:</span>
                    <span class="meeting-info-value">@(startTime != DateTime.MinValue ? startTime.ToString("HH:mm") : "Unknown")</span>
                </div>
                @if (startTime != DateTime.MinValue && endTime.HasValue)
                {
                    var duration = DateTime.Today.Add(endTime.Value) - startTime;
                    if (duration.TotalSeconds < 0) 
                    {
                        duration = duration.Add(TimeSpan.FromDays(1));
                    }
                    <div class="meeting-info-row">
                        <span class="meeting-info-label">Duration:</span>
                        <span class="meeting-info-value">@($"{(int)duration.TotalHours}h {duration.Minutes}m")</span>
                    </div>
                }
            </div>

            <!-- End Time Selection -->
            <MudTimePicker Time="@endTime"
                           TimeChanged="OnTimeChanged"
                           Label="Meeting End Time"
                           Variant="Variant.Outlined"
                           Margin="Margin.Dense"
                           Editable="true"
                           AmPm="false"
                           TimeFormat="HH:mm"
                           TimeEditFormat="HH:mm"
                           PickerVariant="PickerVariant.Dialog"
                           Required="true"
                           Error="@(!endTime.HasValue && showValidation)"
                           ErrorText="@(showValidation && !endTime.HasValue ? "End time is required" : string.Empty)"
                           aria-label="Select meeting end time" />

            <div class="time-adjustment-group">
                <MudButton Variant="Variant.Text" 
                           Size="Size.Small" 
                           OnClick="@(() => SubtractMinutes(5))"
                           StartIcon="@Icons.Material.Filled.Remove"
                           aria-label="Subtract 5 minutes">
                    5m
                </MudButton>
                <MudButton Variant="Variant.Text" 
                           Size="Size.Small" 
                           OnClick="@(() => SubtractMinutes(10))"
                           StartIcon="@Icons.Material.Filled.Remove"
                           aria-label="Subtract 10 minutes">
                    10m
                </MudButton>
                <MudButton Variant="Variant.Text" 
                           Size="Size.Small" 
                           OnClick="@(() => SubtractMinutes(15))"
                           StartIcon="@Icons.Material.Filled.Remove"
                           aria-label="Subtract 15 minutes">
                    15m
                </MudButton>
                <MudButton Variant="Variant.Text" 
                           Size="Size.Small" 
                           Color="Color.Primary"
                           OnClick="ResetToCurrentTime"
                           StartIcon="@Icons.Material.Filled.Refresh"
                           aria-label="Reset to current time">
                    Now
                </MudButton>
            </div>

            <MudTextField @bind-Value="customDescription"
                          Label="Description (optional)"
                          Placeholder="@meetingTitle"
                          Variant="Variant.Outlined"
                          Lines="2"
                          Margin="Margin.Dense"
                          Class="mt-3"
                          aria-label="Meeting description" />

            <MudButton Variant="Variant.Filled" 
                       Color="Color.Success" 
                       FullWidth="true" 
                       OnClick="ConfirmEnd"
                       Disabled="isProcessing"
                       StartIcon="@Icons.Material.Filled.CheckCircle"
                       Class="mt-3"
                       aria-label="Confirm meeting ended">
                @if (isProcessing)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                }
                else
                {
                    <span>Confirm End</span>
                }
            </MudButton>

            <!-- Postpone Section -->
            <div class="mt-3">
                <div class="postpone-header">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">
                        <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Small" Class="mr-1" />
                        Postpone Check
                    </MudText>
                </div>

                <MudStack Spacing="1" Class="mt-2">
                    <MudStack Row="true" Spacing="1" Justify="Justify.Center">
                        <MudButton Variant="Variant.Outlined" 
                                   Size="Size.Small" 
                                   Color="Color.Info"
                                   OnClick="@(() => Postpone(5))"
                                   Disabled="isProcessing"
                                   StartIcon="@Icons.Material.Filled.Schedule">
                            +5m
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" 
                                   Size="Size.Small" 
                                   Color="Color.Info"
                                   OnClick="@(() => Postpone(10))"
                                   Disabled="isProcessing"
                                   StartIcon="@Icons.Material.Filled.Schedule">
                            +10m
                        </MudButton>
                        <MudButton Variant="Variant.Outlined" 
                                   Size="Size.Small" 
                                   Color="Color.Info"
                                   OnClick="@(() => Postpone(15))"
                                   Disabled="isProcessing"
                                   StartIcon="@Icons.Material.Filled.Schedule">
                            +15m
                        </MudButton>
                    </MudStack>

                    <MudTimePicker Time="@postponeTime"
                                   TimeChanged="OnPostponeTimeChanged"
                                   Label="Custom Postpone Time"
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Editable="true"
                                   AmPm="false"
                                   TimeFormat="HH:mm"
                                   TimeEditFormat="HH:mm"
                                   PickerVariant="PickerVariant.Dialog"
                                   aria-label="Select custom postpone time" />
                </MudStack>
            </div>

            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <MudAlert Severity="Severity.Error" Dense="true" Class="mt-2">@errorMessage</MudAlert>
            }
        </div>

        <!-- Fixed action footer -->
        <div class="action-footer">
            <MudButton Variant="Variant.Outlined" 
                       FullWidth="true" 
                       OnClick="StillOngoing"
                       Disabled="isProcessing"
                       StartIcon="@Icons.Material.Filled.AccessTime"
                       aria-label="Meeting still ongoing">
                @if (postponeTime.HasValue)
                {
                    <span>Still Ongoing - Postpone Until @postponeTime.Value.ToString(@"hh\:mm")</span>
                }
                else
                {
                    <span>Still Ongoing</span>
                }
            </MudButton>
        </div>
    </div>
}
else
{
    <div style="padding: 16px;">
        <MudAlert Severity="Severity.Warning">Meeting confirmation expired or already handled</MudAlert>
    </div>
}

@code {
    [Parameter]
    public string MeetingGuidString { get; set; } = string.Empty;

    [CascadingParameter(Name = "ParentMauiWindowId")]
    public Guid ParentMauiWindowId { get; set; }

    private Guid meetingGuid;
    private string? meetingTitle;
    private DateTime startTime = DateTime.MinValue;
    private TimeSpan? endTime;
    private string? customDescription;
    private string errorMessage = string.Empty;
    private bool isProcessing;
    private bool showValidation;
    private bool _userResponded;
    private CancellationTokenSource _timeoutCts = new();
    private TimeSpan? postponeTime;

    protected override void OnInitialized()
    {
        if (Guid.TryParse(MeetingGuidString, out meetingGuid))
        {
            var uri = new Uri(navigationManager.Uri);
            var queryParams = System.Web.HttpUtility.ParseQueryString(uri.Query);
            
            meetingTitle = queryParams["title"];
            
            // Parse start time from event payload (passed as ticks)
            if (long.TryParse(queryParams["startTime"], out var startTimeTicks))
            {
                startTime = new DateTime(startTimeTicks);
            }
            else
            {
                // Fallback only if parameter missing
                startTime = DateTime.Now;
            }
            
            // Always default end time to current time
            endTime = DateTime.Now.TimeOfDay;
        }
    }

    private void SubtractMinutes(int minutes)
    {
        if (!endTime.HasValue) return;
        
        // Work directly with TimeSpan for simpler logic
        var newEndTime = endTime.Value.Subtract(TimeSpan.FromMinutes(minutes));
        
        // Handle negative values (wrap to previous day scenario)
        if (newEndTime < TimeSpan.Zero)
        {
            newEndTime = TimeSpan.Zero;
        }
        
        // Ensure end time doesn't go before start time (same day comparison)
        if (startTime != DateTime.MinValue)
        {
            var startTimeSpan = startTime.TimeOfDay;
            if (newEndTime < startTimeSpan)
            {
                newEndTime = startTimeSpan;
            }
        }
        
        endTime = newEndTime;
        StateHasChanged();
    }

    private void ResetToCurrentTime()
    {
        endTime = DateTime.Now.TimeOfDay;
        StateHasChanged();
    }

    private void OnTimeChanged(TimeSpan? newTime)
    {
        endTime = newTime;
        if (showValidation)
        {
            errorMessage = string.Empty;
        }
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(meetingTitle))
        {
            _ = Task.Run(async () =>
            {
                try
                {
                    await Task.Delay(TimeSpan.FromMinutes(10), _timeoutCts.Token);
                    
                    await InvokeAsync(async () =>
                    {
                        if (!_userResponded)
                        {
                            await StillOngoing();
                        }
                    });
                }
                catch (TaskCanceledException)
                {
                    // User responded before timeout
                }
            });
        }
    }

    private async Task ConfirmEnd()
    {
        if (string.IsNullOrEmpty(meetingTitle) || isProcessing)
            return;

        showValidation = true;

        if (!endTime.HasValue)
        {
            errorMessage = "Please enter a valid end time in HH:mm format";
            StateHasChanged();
            return;
        }

        _userResponded = true;
        _timeoutCts.Cancel();
        isProcessing = true;
        errorMessage = string.Empty;

        try
        {
            DateTime? customEndTime = null;
            if (endTime.HasValue)
            {
                customEndTime = startTime.Date.Add(endTime.Value);
                
                if (customEndTime < startTime)
                {
                    customEndTime = customEndTime.Value.AddDays(1);
                }
            }

            // Try to confirm pending meeting first, if that fails try manual end
            try
            {
                await meetingService.ConfirmMeetingEndAsync(meetingGuid, customDescription, customEndTime);
            }
            catch (InvalidOperationException)
            {
                // Meeting is not in pending state, try manual end
                await meetingService.EndMeetingManuallyAsync(meetingGuid, customDescription, customEndTime);
            }
            
            await CloseWindow();
        }
        catch (ArgumentException ex)
        {
            errorMessage = ex.Message;
            isProcessing = false;
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
            isProcessing = false;
        }
        catch (Exception)
        {
            errorMessage = "An error occurred while confirming the meeting end. Please try again.";
            isProcessing = false;
        }
    }

    private async Task StillOngoing()
    {
        if (string.IsNullOrEmpty(meetingTitle))
            return;

        _userResponded = true;
        _timeoutCts.Cancel();

        // If custom postpone time is set, postpone to that time
        if (postponeTime.HasValue)
        {
            await PostponeUntilSelectedTime();
            return;
        }

        // Otherwise, just cancel and let default recognition continue
        meetingService.CancelPendingEnd(meetingGuid);
        await CloseWindow();
    }

    private async Task CloseWindow()
    {
        await mediator.Send(new CloseWindowCommand(ParentMauiWindowId));
    }

    private void OnPostponeTimeChanged(TimeSpan? newTime)
    {
        postponeTime = newTime;
        // Trigger re-render to update "Still Ongoing" button text
        StateHasChanged();
    }

    private async Task Postpone(int minutes)
    {
        if (string.IsNullOrEmpty(meetingTitle) || isProcessing)
            return;

        var postponeUntil = DateTime.Now.AddMinutes(minutes);
        await ExecutePostpone(postponeUntil);
    }

    private async Task PostponeUntilSelectedTime()
    {
        if (!postponeTime.HasValue || string.IsNullOrEmpty(meetingTitle) || isProcessing)
            return;

        var today = DateTime.Today;
        var selectedTime = today.Add(postponeTime.Value);
        
        // If selected time is in the past today, assume user means tomorrow
        if (selectedTime < DateTime.Now)
        {
            selectedTime = selectedTime.AddDays(1);
        }
        
        // Validate not more than 24 hours
        if (selectedTime > DateTime.Now.AddHours(24))
        {
            errorMessage = "Postpone time cannot exceed 24 hours from now";
            StateHasChanged();
            return;
        }

        await ExecutePostpone(selectedTime);
    }

    private async Task ExecutePostpone(DateTime postponeUntil)
    {
        _userResponded = true;
        _timeoutCts.Cancel();
        isProcessing = true;
        errorMessage = string.Empty;

        try
        {
            await meetingService.PostponeCheckAsync(meetingGuid, postponeUntil);
            await CloseWindow();
        }
        catch (ArgumentException ex)
        {
            errorMessage = ex.Message;
            isProcessing = false;
            StateHasChanged();
        }
        catch (Exception)
        {
            errorMessage = "An error occurred while postponing. Please try again.";
            isProcessing = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _timeoutCts?.Cancel();
        _timeoutCts?.Dispose();
    }
}
