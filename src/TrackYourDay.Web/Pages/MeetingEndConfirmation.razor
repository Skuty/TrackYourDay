@page "/MeetingEndConfirmation/{MeetingGuidString}"
@implements IDisposable

@using TrackYourDay.Core.ApplicationTrackers.MsTeams
@using TrackYourDay.Core.MAUIProxy
@using MediatR

@inject IMediator mediator
@inject MsTeamsMeetingTracker meetingService
@inject NavigationManager navigationManager

<MudContainer MaxWidth="MaxWidth.Small" Class="py-4">
    @if (!string.IsNullOrEmpty(meetingTitle))
    {
        <MudPaper Class="pa-6" Elevation="3">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6" Align="Align.Center" Color="Color.Warning">
                    Did this meeting end?
                </MudText>

                <MudStack Spacing="2">
                    <MudText Typo="Typo.body2">
                        <strong>Meeting:</strong> @meetingTitle
                    </MudText>
                    <MudText Typo="Typo.body2">
                        <strong>Start:</strong> @(startTime != DateTime.MinValue ? startTime.ToString("HH:mm") : "Unknown")
                    </MudText>
                </MudStack>

                <MudStack Spacing="2">
                    <MudTimePicker Time="@endTime"
                                   TimeChanged="OnTimeChanged"
                                   Label="End Time"
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Editable="true"
                                   AmPm="false"
                                   TimeFormat="HH:mm"
                                   TimeEditFormat="HH:mm"
                                   PickerVariant="PickerVariant.Dialog"
                                   Required="true"
                                   RequiredError="Please enter a valid time in HH:mm format"
                                   Error="@(!endTime.HasValue && showValidation)"
                                   ErrorText="@(showValidation && !endTime.HasValue ? "End time is required" : string.Empty)" />
                    
                    <MudStack Row="true" Spacing="1" Justify="Justify.Center">
                        <MudButton Variant="Variant.Text" 
                                   Size="Size.Small" 
                                   OnClick="@(() => SubtractMinutes(5))"
                                   StartIcon="@Icons.Material.Filled.Remove">
                            5m
                        </MudButton>
                        <MudButton Variant="Variant.Text" 
                                   Size="Size.Small" 
                                   OnClick="@(() => SubtractMinutes(10))"
                                   StartIcon="@Icons.Material.Filled.Remove">
                            10m
                        </MudButton>
                        <MudButton Variant="Variant.Text" 
                                   Size="Size.Small" 
                                   OnClick="@(() => SubtractMinutes(15))"
                                   StartIcon="@Icons.Material.Filled.Remove">
                            15m
                        </MudButton>
                        <MudButton Variant="Variant.Text" 
                                   Size="Size.Small" 
                                   Color="Color.Primary"
                                   OnClick="ResetToCurrentTime"
                                   StartIcon="@Icons.Material.Filled.Refresh">
                            Now
                        </MudButton>
                    </MudStack>
                </MudStack>

                <MudTextField @bind-Value="customDescription"
                              Label="Description (optional)"
                              Placeholder="@meetingTitle"
                              Variant="Variant.Outlined"
                              Lines="2"
                              Margin="Margin.Dense" />

                @if (!string.IsNullOrEmpty(errorMessage))
                {
                    <MudAlert Severity="Severity.Error" Dense="true">@errorMessage</MudAlert>
                }

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Filled" 
                               Color="Color.Success" 
                               FullWidth="true" 
                               OnClick="ConfirmEnd"
                               Disabled="isProcessing">
                        Confirm
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                               FullWidth="true" 
                               OnClick="StillOngoing"
                               Disabled="isProcessing">
                        Still Ongoing
                    </MudButton>
                </MudStack>
            </MudStack>
        </MudPaper>
    }
    else
    {
        <MudAlert Severity="Severity.Warning">Meeting confirmation expired or already handled</MudAlert>
    }
</MudContainer>

@code {
    [Parameter]
    public string MeetingGuidString { get; set; } = string.Empty;

    [CascadingParameter(Name = "ParentMauiWindowId")]
    public Guid ParentMauiWindowId { get; set; }

    private Guid meetingGuid;
    private string? meetingTitle;
    private DateTime startTime = DateTime.MinValue;
    private TimeSpan? endTime;
    private string? customDescription;
    private string errorMessage = string.Empty;
    private bool isProcessing;
    private bool showValidation;
    private bool _userResponded;
    private CancellationTokenSource _timeoutCts = new();

    protected override void OnInitialized()
    {
        if (Guid.TryParse(MeetingGuidString, out meetingGuid))
        {
            var uri = new Uri(navigationManager.Uri);
            var query = uri.Query;
            
            if (!string.IsNullOrEmpty(query) && query.Contains("title="))
            {
                var titleParam = query.Split('&')
                    .Select(p => p.TrimStart('?'))
                    .FirstOrDefault(p => p.StartsWith("title="));
                    
                if (titleParam != null)
                {
                    meetingTitle = System.Web.HttpUtility.UrlDecode(titleParam.Substring("title=".Length));
                }
            }
            
            // Get meeting start time from tracker
            var ongoing = meetingService.GetOngoingMeeting();
            if (ongoing?.Guid == meetingGuid)
            {
                startTime = ongoing.StartDate != DateTime.MinValue ? ongoing.StartDate : DateTime.Now;
            }
            else
            {
                // Fallback: if meeting not found, use current time
                startTime = DateTime.Now;
            }
            
            // Always default end time to current time
            endTime = DateTime.Now.TimeOfDay;
        }
    }

    private void SubtractMinutes(int minutes)
    {
        if (!endTime.HasValue) return;
        
        // Work directly with TimeSpan for simpler logic
        var newEndTime = endTime.Value.Subtract(TimeSpan.FromMinutes(minutes));
        
        // Handle negative values (wrap to previous day scenario)
        if (newEndTime < TimeSpan.Zero)
        {
            newEndTime = TimeSpan.Zero;
        }
        
        // Ensure end time doesn't go before start time (same day comparison)
        if (startTime != DateTime.MinValue)
        {
            var startTimeSpan = startTime.TimeOfDay;
            if (newEndTime < startTimeSpan)
            {
                newEndTime = startTimeSpan;
            }
        }
        
        endTime = newEndTime;
        StateHasChanged();
    }

    private void ResetToCurrentTime()
    {
        endTime = DateTime.Now.TimeOfDay;
        StateHasChanged();
    }

    private void OnTimeChanged(TimeSpan? newTime)
    {
        endTime = newTime;
        if (showValidation)
        {
            errorMessage = string.Empty;
        }
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !string.IsNullOrEmpty(meetingTitle))
        {
            _ = Task.Run(async () =>
            {
                try
                {
                    await Task.Delay(TimeSpan.FromMinutes(10), _timeoutCts.Token);
                    
                    await InvokeAsync(async () =>
                    {
                        if (!_userResponded)
                        {
                            await StillOngoing();
                        }
                    });
                }
                catch (TaskCanceledException)
                {
                    // User responded before timeout
                }
            });
        }
    }

    private async Task ConfirmEnd()
    {
        if (string.IsNullOrEmpty(meetingTitle) || isProcessing)
            return;

        showValidation = true;

        if (!endTime.HasValue)
        {
            errorMessage = "Please enter a valid end time in HH:mm format";
            StateHasChanged();
            return;
        }

        _userResponded = true;
        _timeoutCts.Cancel();
        isProcessing = true;
        errorMessage = string.Empty;

        try
        {
            DateTime? customEndTime = null;
            if (endTime.HasValue)
            {
                customEndTime = startTime.Date.Add(endTime.Value);
                
                if (customEndTime < startTime)
                {
                    customEndTime = customEndTime.Value.AddDays(1);
                }
            }

            // Try to confirm pending meeting first, if that fails try manual end
            try
            {
                await meetingService.ConfirmMeetingEndAsync(meetingGuid, customDescription, customEndTime);
            }
            catch (InvalidOperationException)
            {
                // Meeting is not in pending state, try manual end
                await meetingService.EndMeetingManuallyAsync(meetingGuid, customDescription, customEndTime);
            }
            
            await CloseWindow();
        }
        catch (ArgumentException ex)
        {
            errorMessage = ex.Message;
            isProcessing = false;
        }
        catch (InvalidOperationException ex)
        {
            errorMessage = ex.Message;
            isProcessing = false;
        }
        catch (Exception)
        {
            errorMessage = "An error occurred while confirming the meeting end. Please try again.";
            isProcessing = false;
        }
    }

    private async Task StillOngoing()
    {
        if (string.IsNullOrEmpty(meetingTitle))
            return;

        _userResponded = true;
        _timeoutCts.Cancel();

        meetingService.CancelPendingEnd(meetingGuid);
        await CloseWindow();
    }

    private async Task CloseWindow()
    {
        await mediator.Send(new CloseWindowCommand(ParentMauiWindowId));
    }

    public void Dispose()
    {
        _timeoutCts?.Cancel();
        _timeoutCts?.Dispose();
    }
}
