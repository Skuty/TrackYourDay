@page "/settings"
@using TrackYourDay.Core.Settings
@using TrackYourDay.Core.ApplicationTrackers.Breaks
@using TrackYourDay.Core.ApplicationTrackers.GitLab
@using TrackYourDay.Core.ApplicationTrackers.Jira
@using TrackYourDay.Core.ApplicationTrackers.MsTeams
@using TrackYourDay.Core.SystemTrackers
@using TrackYourDay.Core.Persistence
@using Microsoft.Extensions.Logging

<h1>Settings</h1>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
    <MudTabPanel Text="Breaks">
        <MudText>
            How many minutes should pass without any Activity to Start Break?
        </MudText>
        <MudSlider @bind-Value="minutesOfNoActivityToStartBreak"  TickMarks="true" Step="1" Min="1" Max="60">
            @this.minutesOfNoActivityToStartBreak.ToString() minutes
        </MudSlider>
    </MudTabPanel>
    <MudTabPanel Text="GitLab Integration"> 
        <MudSwitch @bind-Checked="gitLabEnabled" Color="Color.Primary" Label="Enabled" Class="mb-2" />
        <MudText>
            GitLab credentials are encrypted at rest using AES with your Windows Account SID as salt.
        </MudText>
        <MudTextField @bind-Value="gitLabApiUrl" @bind-Value:event="oninput" Immediate="true" Label="GitLab API URL" Variant="Variant.Outlined" />
        <MudTextField @bind-Value="gitLabApiKey" @bind-Value:event="oninput" Immediate="true" Label="GitLab API Key" Variant="Variant.Outlined" InputType="InputType.Password" />
        <MudNumericField T="int" @bind-Value="gitLabFetchIntervalMinutes" @bind-Value:event="oninput" Immediate="true" Label="Fetch Interval (minutes)" Variant="Variant.Outlined" Min="1" Max="1440" Class="mt-2" />
        <MudNumericField T="int" @bind-Value="gitLabCircuitBreakerThreshold" @bind-Value:event="oninput" Immediate="true" Label="Circuit Breaker Threshold" Variant="Variant.Outlined" Min="1" Max="100" Class="mt-2" />
        <MudNumericField T="int" @bind-Value="gitLabCircuitBreakerDurationMinutes" @bind-Value:event="oninput" Immediate="true" Label="Circuit Breaker Duration (minutes)" Variant="Variant.Outlined" Min="1" Max="1440" Class="mt-2" />
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="CheckGitLabConnection" Class="mt-2">Check Connection</MudButton>
    </MudTabPanel>
    <MudTabPanel Text="Jira Integration">
        <MudSwitch @bind-Checked="jiraEnabled" Color="Color.Primary" Label="Enabled" Class="mb-2" />
        <MudText>
            Jira credentials are encrypted at rest using AES with your Windows Account SID as salt.
        </MudText>
        <MudTextField @bind-Value="jiraApiUrl" @bind-Value:event="oninput" Immediate="true" Label="Jira API URL" Variant="Variant.Outlined" />
        <MudTextField @bind-Value="jiraApiKey" @bind-Value:event="oninput" Immediate="true" Label="Jira API Key" Variant="Variant.Outlined" InputType="InputType.Password" />
        <MudNumericField T="int" @bind-Value="jiraFetchIntervalMinutes" @bind-Value:event="oninput" Immediate="true" Label="Fetch Interval (minutes)" Variant="Variant.Outlined" Min="1" Max="1440" Class="mt-2" />
        <MudNumericField T="int" @bind-Value="jiraCircuitBreakerThreshold" @bind-Value:event="oninput" Immediate="true" Label="Circuit Breaker Threshold" Variant="Variant.Outlined" Min="1" Max="100" Class="mt-2" />
        <MudNumericField T="int" @bind-Value="jiraCircuitBreakerDurationMinutes" @bind-Value:event="oninput" Immediate="true" Label="Circuit Breaker Duration (minutes)" Variant="Variant.Outlined" Min="1" Max="1440" Class="mt-2" />
        <MudButton Variant="Variant.Outlined" Color="Color.Primary" OnClick="CheckJiraConnection" Class="mt-2">Check Connection</MudButton>
    </MudTabPanel>
    <MudTabPanel Text="Database Management">
        <MudText Typo="Typo.h6">Storage Overview</MudText>
        <MudText Typo="Typo.body2">Activities: @activitiesCount records (@FormatBytes(activitiesSize))</MudText>
        <MudText Typo="Typo.body2">Breaks: @breaksCount records (@FormatBytes(breaksSize))</MudText>
        <MudText Typo="Typo.body2">Meetings: @meetingsCount records (@FormatBytes(meetingsSize))</MudText>
        <MudText Typo="Typo.body2">Total Storage: @FormatBytes(totalSize)</MudText>
        <MudDivider Class="my-4" />
        <MudText Typo="Typo.h6" Class="mb-2">Clear All Historical Data</MudText>
        <MudText Typo="Typo.body2" Color="Color.Warning">Warning: This action cannot be undone!</MudText>
        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="ShowClearDatabaseDialog" Class="mt-2">Clear Database</MudButton>
    </MudTabPanel>
    <MudTabPanel Text="LLM Prompt Templates" Icon="@Icons.Material.Filled.TextSnippet">
        <TemplateManagement />
    </MudTabPanel>
    <MudTabPanel Text="Meeting Recognition" Icon="@Icons.Material.Filled.VideoCall">
        <MeetingRecognitionTab />
    </MudTabPanel>
</MudTabs>

<MudDialog @bind-IsVisible="isSettingsSavedDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Edit" Class="mr-3" /> Settings saved
        </MudText>
    </TitleContent>
    <DialogContent>
        <p>New settings will be used after restarting application..</p>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HideSettingsSavedDialog" Class="px-10">Got it!</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-IsVisible="isClearDatabaseDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Warning" Class="mr-3" Color="Color.Error" /> Confirm Database Clear
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText>Are you sure you want to delete all historical data?</MudText>
        <MudText Color="Color.Error">This will permanently remove:</MudText>
        <ul>
            <li>@activitiesCount activity records</li>
            <li>@breaksCount break records</li>
            <li>@meetingsCount meeting records</li>
        </ul>
        <MudText>This action cannot be undone!</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Text" OnClick="HideClearDatabaseDialog">Cancel</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="ClearDatabase">Clear All Data</MudButton>
    </DialogActions>
</MudDialog>

<MudDialog @bind-IsVisible="isConnectionCheckDialogVisible">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@(connectionCheckSuccess ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Error)" 
                     Class="mr-3" 
                     Color="@(connectionCheckSuccess ? Color.Success : Color.Error)" /> 
            Connection Check
        </MudText>
    </TitleContent>
    <DialogContent>
        <MudText>@connectionCheckMessage</MudText>
    </DialogContent>
    <DialogActions>
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="HideConnectionCheckDialog">OK</MudButton>
    </DialogActions>
</MudDialog>

<MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="SaveSettings">Save</MudButton>

@code {
    [Inject]
    private IBreaksSettingsService breaksSettingsService { get; init; }
    
    [Inject]
    private IGitLabSettingsService gitLabSettingsService { get; init; }
    
    [Inject]
    private IJiraSettingsService jiraSettingsService { get; init; }
    
    [Inject]
    private IHistoricalDataRepository<EndedActivity> activityRepository { get; init; }
    
    [Inject]
    private IHistoricalDataRepository<EndedBreak> breakRepository { get; init; }
    
    [Inject]
    private IHistoricalDataRepository<EndedMeeting> meetingRepository { get; init; }

    [Inject]
    private IGitLabActivityService gitLabActivityService { get; init; }
    
    [Inject]
    private IJiraActivityService jiraActivityService { get; init; }
    
    [Inject]
    private ILogger<Settings> logger { get; init; }

    private int minutesOfNoActivityToStartBreak = 5;
    private bool isSettingsSavedDialogVisible;
    private bool isClearDatabaseDialogVisible;
    private string gitLabApiUrl = string.Empty;
    private string gitLabApiKey = string.Empty;
    private bool gitLabEnabled = false;
    private string jiraApiUrl = string.Empty;
    private string jiraApiKey = string.Empty;
    private bool jiraEnabled = false;
    private int gitLabFetchIntervalMinutes = 15;
    private int gitLabCircuitBreakerThreshold = 5;
    private int gitLabCircuitBreakerDurationMinutes = 5;
    private int jiraFetchIntervalMinutes = 15;
    private int jiraCircuitBreakerThreshold = 5;
    private int jiraCircuitBreakerDurationMinutes = 5;
    
    private long activitiesSize;
    private long breaksSize;
    private long meetingsSize;
    private long totalSize;
    private int activitiesCount;
    private int breaksCount;
    private int meetingsCount;
    
    private bool isConnectionCheckDialogVisible;
    private bool connectionCheckSuccess;
    private string connectionCheckMessage = string.Empty;

    protected override void OnInitialized()
    {
        this.LoadSettings();
        this.LoadDatabaseStats();
    }

    private void ShowSettingsSavedDialog() => isSettingsSavedDialogVisible = true;
    private void HideSettingsSavedDialog() => isSettingsSavedDialogVisible = false;
    
    private void ShowClearDatabaseDialog() => isClearDatabaseDialogVisible = true;
    private void HideClearDatabaseDialog() => isClearDatabaseDialogVisible = false;
    
    private void ShowConnectionCheckDialog() => isConnectionCheckDialogVisible = true;
    private void HideConnectionCheckDialog() => isConnectionCheckDialogVisible = false;

    private void LoadSettings()
    {
        var breaksSettings = this.breaksSettingsService.GetSettings();
        this.minutesOfNoActivityToStartBreak = (int)breaksSettings.TimeOfNoActivityToStartBreak.TotalMinutes;

        var gitLabSettings = this.gitLabSettingsService.GetSettings();
        this.gitLabApiUrl = gitLabSettings.ApiUrl;
        this.gitLabApiKey = gitLabSettings.ApiKey;
        this.gitLabEnabled = gitLabSettings.Enabled;
        this.gitLabFetchIntervalMinutes = gitLabSettings.FetchIntervalMinutes;
        this.gitLabCircuitBreakerThreshold = gitLabSettings.CircuitBreakerThreshold;
        this.gitLabCircuitBreakerDurationMinutes = gitLabSettings.CircuitBreakerDurationMinutes;

        var jiraSettings = this.jiraSettingsService.GetSettings();
        this.jiraApiUrl = jiraSettings.ApiUrl;
        this.jiraApiKey = jiraSettings.ApiKey;
        this.jiraEnabled = jiraSettings.Enabled;
        this.jiraFetchIntervalMinutes = jiraSettings.FetchIntervalMinutes;
        this.jiraCircuitBreakerThreshold = jiraSettings.CircuitBreakerThreshold;
        this.jiraCircuitBreakerDurationMinutes = jiraSettings.CircuitBreakerDurationMinutes;
    }
    
    private void LoadDatabaseStats()
    {
        activitiesSize = activityRepository.GetDatabaseSizeInBytes();
        activitiesCount = activityRepository.GetTotalRecordCount();
        
        breaksSize = breakRepository.GetDatabaseSizeInBytes();
        breaksCount = breakRepository.GetTotalRecordCount();
        
        meetingsSize = meetingRepository.GetDatabaseSizeInBytes();
        meetingsCount = meetingRepository.GetTotalRecordCount();
        
        totalSize = activitiesSize + breaksSize + meetingsSize;
    }
    
    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }
    
    private void ClearDatabase()
    {
        activityRepository.Clear();
        breakRepository.Clear();
        meetingRepository.Clear();
        
        HideClearDatabaseDialog();
        LoadDatabaseStats();
        StateHasChanged();
    }

    private async System.Threading.Tasks.Task SaveSettings()
    {
        // Small yield to ensure UI input events are applied before validation
        await System.Threading.Tasks.Task.Delay(1);
n        // Persist break settings first
        this.breaksSettingsService.UpdateTimeOfNoActivityToStartBreak(TimeSpan.FromMinutes(this.minutesOfNoActivityToStartBreak));
        this.breaksSettingsService.PersistSettings();
n        // Snapshot current UI values to avoid race conditions during validation/save
        var gitLabApiUrlLocal = this.gitLabApiUrl?.Trim() ?? string.Empty;
        var gitLabApiKeyLocal = this.gitLabApiKey ?? string.Empty;
        var gitLabEnabledLocal = this.gitLabEnabled;
        var gitLabFetchIntervalLocal = this.gitLabFetchIntervalMinutes;
        var gitLabCbThresholdLocal = this.gitLabCircuitBreakerThreshold;
        var gitLabCbDurationLocal = this.gitLabCircuitBreakerDurationMinutes;
n        var jiraApiUrlLocal = this.jiraApiUrl?.Trim() ?? string.Empty;
        var jiraApiKeyLocal = this.jiraApiKey ?? string.Empty;
        var jiraEnabledLocal = this.jiraEnabled;
        var jiraFetchIntervalLocal = this.jiraFetchIntervalMinutes;
        var jiraCbThresholdLocal = this.jiraCircuitBreakerThreshold;
        var jiraCbDurationLocal = this.jiraCircuitBreakerDurationMinutes;
n        // Validate GitLab settings when enabled
        if (gitLabEnabledLocal)
        {
            var gitLabErrors = new System.Collections.Generic.List<string>();
            if (string.IsNullOrWhiteSpace(gitLabApiUrlLocal))
                gitLabErrors.Add("GitLab API URL cannot be empty.");
            if (string.IsNullOrWhiteSpace(gitLabApiKeyLocal))
                gitLabErrors.Add("GitLab API Key cannot be empty.");
            if (gitLabFetchIntervalLocal < 1)
                gitLabErrors.Add("GitLab Fetch Interval must be at least 1 minute.");
            if (gitLabCbThresholdLocal < 1)
                gitLabErrors.Add("GitLab Circuit Breaker Threshold must be at least 1.");
            if (gitLabCbDurationLocal < 1)
                gitLabErrors.Add("GitLab Circuit Breaker Duration must be at least 1 minute.");
n            if (gitLabErrors.Count > 0)
            {
                connectionCheckSuccess = false;
                connectionCheckMessage = string.Join("\n", gitLabErrors);
                ShowConnectionCheckDialog();
                return;
            }
        }
n        try
        {
            this.gitLabSettingsService.UpdateSettings(
                gitLabApiUrlLocal,
                gitLabApiKeyLocal,
                gitLabEnabledLocal,
                gitLabFetchIntervalLocal,
                gitLabCbThresholdLocal,
                gitLabCbDurationLocal);
            this.gitLabSettingsService.PersistSettings();
        }
        catch (System.Exception ex)
        {
            // If persisting fails, reload previous values so UI doesn't show blanks
            this.LoadSettings();
            connectionCheckSuccess = false;
            connectionCheckMessage = $"Failed to save GitLab settings: {ex.Message}";
            ShowConnectionCheckDialog();
            return;
        }
n        // Validate Jira settings when enabled
        if (jiraEnabledLocal)
        {
            var jiraErrors = new System.Collections.Generic.List<string>();
            if (string.IsNullOrWhiteSpace(jiraApiUrlLocal))
                jiraErrors.Add("Jira API URL cannot be empty.");
            if (string.IsNullOrWhiteSpace(jiraApiKeyLocal))
                jiraErrors.Add("Jira API Key cannot be empty.");
            if (jiraFetchIntervalLocal < 1)
                jiraErrors.Add("Jira Fetch Interval must be at least 1 minute.");
            if (jiraCbThresholdLocal < 1)
                jiraErrors.Add("Jira Circuit Breaker Threshold must be at least 1.");
            if (jiraCbDurationLocal < 1)
                jiraErrors.Add("Jira Circuit Breaker Duration must be at least 1 minute.");
n            if (jiraErrors.Count > 0)
            {
                connectionCheckSuccess = false;
                connectionCheckMessage = string.Join("\n", jiraErrors);
                ShowConnectionCheckDialog();
                return;
            }
        }
n        try
        {
            this.jiraSettingsService.UpdateSettings(
                jiraApiUrlLocal,
                jiraApiKeyLocal,
                jiraEnabledLocal,
                jiraFetchIntervalLocal,
                jiraCbThresholdLocal,
                jiraCbDurationLocal);
            this.jiraSettingsService.PersistSettings();
        }
        catch (System.Exception ex)
        {
            // Reload previous settings on failure so UI remains consistent
            this.LoadSettings();
            connectionCheckSuccess = false;
            connectionCheckMessage = $"Failed to save Jira settings: {ex.Message}";
            ShowConnectionCheckDialog();
            return;
        }
n        // Reload saved settings to make sure UI reflects persisted values (avoids transient blanking)
        this.LoadSettings();
        this.ShowSettingsSavedDialog();
    }
    
    private async Task CheckGitLabConnection()
    {
        if (string.IsNullOrWhiteSpace(this.gitLabApiUrl))
        {
            connectionCheckSuccess = false;
            connectionCheckMessage = "GitLab API URL cannot be empty.";
            ShowConnectionCheckDialog();
            return;
        }
        
        if (string.IsNullOrWhiteSpace(this.gitLabApiKey))
        {
            connectionCheckSuccess = false;
            connectionCheckMessage = "GitLab API Key cannot be empty.";
            ShowConnectionCheckDialog();
            return;
        }
        
        if (!Uri.TryCreate(this.gitLabApiUrl, UriKind.Absolute, out var uri))
        {
            connectionCheckSuccess = false;
            connectionCheckMessage = "Invalid GitLab API URL format. Please provide a valid URL.";
            ShowConnectionCheckDialog();
            return;
        }
        
        try
        {
            var httpClient = new HttpClient
            {
                BaseAddress = uri,
                Timeout = TimeSpan.FromSeconds(30)
            };
            httpClient.DefaultRequestHeaders.Add("PRIVATE-TOKEN", this.gitLabApiKey);
            
            var gitLabClient = new GitLabRestApiClient(httpClient);
            var user = await gitLabClient.GetCurrentUser();

            connectionCheckSuccess = user != null && user.Id > 0 && user.Username != "Not recognized";
            connectionCheckMessage = connectionCheckSuccess 
                ? "Successfully connected to GitLab!" 
                : "Failed to connect to GitLab. Please check your API URL and API Key.";
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error checking GitLab connection");
            connectionCheckSuccess = false;
            connectionCheckMessage = $"Failed to connect to GitLab: {ex.Message}";
        }
        
        ShowConnectionCheckDialog();
    }
    
    private async Task CheckJiraConnection()
    {
        if (string.IsNullOrWhiteSpace(this.jiraApiUrl))
        {
            connectionCheckSuccess = false;
            connectionCheckMessage = "Jira API URL cannot be empty.";
            ShowConnectionCheckDialog();
            return;
        }
        
        if (string.IsNullOrWhiteSpace(this.jiraApiKey))
        {
            connectionCheckSuccess = false;
            connectionCheckMessage = "Jira API Key cannot be empty.";
            ShowConnectionCheckDialog();
            return;
        }
        
        if (!Uri.TryCreate(this.jiraApiUrl, UriKind.Absolute, out var uri))
        {
            connectionCheckSuccess = false;
            connectionCheckMessage = "Invalid Jira API URL format. Please provide a valid URL.";
            ShowConnectionCheckDialog();
            return;
        }
        
        try
        {
            var httpClient = new HttpClient
            {
                BaseAddress = uri,
                Timeout = TimeSpan.FromSeconds(30)
            };
            httpClient.DefaultRequestHeaders.Add("Authorization", $"Bearer {this.jiraApiKey}");
            
            var jiraClient = new JiraRestApiClient(httpClient);
            var user = await jiraClient.GetCurrentUser();

            connectionCheckSuccess = user != null && !string.IsNullOrEmpty(user.DisplayName) && user.DisplayName != "Not recognized";
            connectionCheckMessage = connectionCheckSuccess 
                ? "Successfully connected to Jira!" 
                : "Failed to connect to Jira. Please check your API URL and API Key.";
        }
        catch (Exception ex)
        {
            logger.LogError(ex, "Error checking Jira connection");
            connectionCheckSuccess = false;
            connectionCheckMessage = $"Failed to connect to Jira: {ex.Message}";
        }
        
        ShowConnectionCheckDialog();
    }
}