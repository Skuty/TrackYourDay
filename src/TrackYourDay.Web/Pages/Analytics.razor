@page "/analytics"
@using TrackYourDay.Core.Insights.Analytics
@using TrackYourDay.Core.SystemTrackers
@using TrackYourDay.Core.ApplicationTrackers.Breaks
@using TrackYourDay.Core
@inject ActivitiesAnalyser activitiesAnalyser
@inject IServiceProvider serviceProvider
@inject ActivityTracker activityTracker
@inject BreakTracker breakTracker
@inject IClock clock

<MudStack Spacing="2">
    <MudGrid>
        <MudItem xs="3">
            <MudDatePicker Label="Start Date" @bind-Date="startDate" />
        </MudItem>
        <MudItem xs="3">
            <MudDatePicker Label="End Date" @bind-Date="endDate" />
        </MudItem>
        <MudItem xs="4">
            <MudSelect T="string" @bind-Value="selectedStrategy" Label="Summary Strategy" Variant="Variant.Outlined"  Class="mud-input-control">
                @foreach (var strategy in availableStrategies)
                {
                    <MudSelectItem Value="@strategy.Key">@strategy.Value.StrategyName</MudSelectItem>
                }
            </MudSelect>
        </MudItem>
        <MudItem xs="2">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GenerateSummary">Generate</MudButton>
        </MudItem>
    </MudGrid>
    <MudDataGrid T="GroupedActivity" Items="@groupedActivities" SortMode="SortMode.Multiple" Filterable="true" QuickFilter="@_quickFilter" Hideable="false">
        <ToolBarContent>
            <MudTextField @bind-Value="_searchString" Placeholder="Search" Adornment="Adornment.Start" Immediate="true"
                            AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0"></MudTextField>
        </ToolBarContent>
        <Columns>
            <PropertyColumn Property="x => x.Date.ToShortDateString()" Title="Date" Filterable="false" />
            <PropertyColumn Property="x => x.Duration" Title="Duration" Filterable="true" SortBy="@_sortByDuration"/>
            <PropertyColumn Property="x => x.Description" Title="Description" Filterable="true" SortBy="@_sortByDescritpion" />
        </Columns>
        <PagerContent>
            <MudDataGridPager T="GroupedActivity" />
        </PagerContent>
    </MudDataGrid>    
</MudStack>

@code {
    private List<GroupedActivity>? groupedActivities = null;
    private string selectedStrategy = "Choose strategy";
    private Dictionary<string, ISummaryStrategy> availableStrategies;
    private DateTime? startDate;
    private DateTime? endDate;

    protected override async Task OnInitializedAsync()
    {
        var strategies = ActivitiesAnalyser.GetAvailableStrategies(serviceProvider);
        availableStrategies = strategies.ToDictionary(s => s.GetType().Name, s => s);
        
        // Set default dates to today
        startDate = DateTime.Now.Date;
        endDate = DateTime.Now.Date;
        
        // Do not generate summary on load
    }

    private async Task GenerateSummary()
    {
        if (startDate == null || endDate == null || string.IsNullOrEmpty(selectedStrategy))
        {
            return;
        }

        ISummaryStrategy strategyInstance = availableStrategies[selectedStrategy];
        
        // Get activities for the date range
        var allActivities = new List<TrackYourDay.Core.SystemTrackers.EndedActivity>();
        var allBreaks = new List<TrackYourDay.Core.ApplicationTrackers.Breaks.EndedBreak>();
        
        var currentDate = startDate.Value;
        while (currentDate <= endDate.Value)
        {
            var dateOnly = DateOnly.FromDateTime(currentDate);
            var dateActivities = activityTracker.GetActivitiesForDate(dateOnly);
            var dateBreaks = breakTracker.GetBreaksForDate(dateOnly);
            
            allActivities.AddRange(dateActivities);
            allBreaks.AddRange(dateBreaks);
            
            currentDate = currentDate.AddDays(1);
        }
        
        // Generate grouped activities using the strategy
        var groupedActivitiesFromStrategy = strategyInstance.Generate(allActivities);
        
        // Apply break reductions
        foreach (var endedBreak in allBreaks)
        {
            var breakPeriod = TrackYourDay.Core.Insights.Analytics.TimePeriod.CreateFrom(endedBreak.BreakStartedAt, endedBreak.BreakEndedAt);
            foreach (var activity in groupedActivitiesFromStrategy)
            {
                activity.ReduceBy(endedBreak.Guid, breakPeriod);
            }
        }
        
        groupedActivities = groupedActivitiesFromStrategy.OrderByDescending(activity => activity.Duration).ToList();
        await InvokeAsync(StateHasChanged);
    }
    
    private string _searchString;

    private Func<GroupedActivity, object> _sortByDuration => x => x.Duration;
    private Func<GroupedActivity, object> _sortByDescritpion => x => x.Description;
    private Func<GroupedActivity, bool> _quickFilter => x =>
    {
        if (string.IsNullOrWhiteSpace(_searchString))
            return true;
        if (x.Description.Contains(_searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    };
}
