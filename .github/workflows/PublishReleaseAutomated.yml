name: Publish Release Automated

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      prerelease:
        description: 'Is this a pre-release version?'
        type: boolean
        required: false
        default: false
      prerelease_tag:
        description: 'Pre-release tag (e.g., alpha, beta, rc)'
        required: false
        default: 'alpha'

jobs:
  calculate-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all tags

      - name: Calculate version
        id: version
        run: |
          # Fetch all tags
          git fetch --tags

          # Get the latest valid tag matching v1.x.y or v1.x.y-prerelease.n
          LATEST_TAG=$(git tag --sort=-version:refname \
            | grep -E '^v1\.[0-9]+\.[0-9]+(-[0-9A-Za-z]+\.[0-9]+)?$' \
            | head -n 1 || true)
          echo "Latest valid tag: $LATEST_TAG"

          # If no valid tags exist, start with 1.0.0
          if [ -z "$LATEST_TAG" ]; then
            MAJOR=1
            MINOR=0
            PATCH=0
          else
            # Parse the latest tag (remove 'v' prefix if present)
            VERSION=${LATEST_TAG#v}
            # Remove any pre-release suffix (e.g., -alpha.1)
            BASE_VERSION=${VERSION%%-*}

            # Split version into components
            IFS='.' read -r MAJOR MINOR PATCH <<< "$BASE_VERSION"

            # Validate that we have exactly three numeric components
            if [ -z "$MAJOR" ] || [ -z "$MINOR" ] || [ -z "$PATCH" ] || \
               ! [[ "$MAJOR" =~ ^[0-9]+$ ]] || ! [[ "$MINOR" =~ ^[0-9]+$ ]] || ! [[ "$PATCH" =~ ^[0-9]+$ ]]; then
              echo "Error: Malformed version tag '$LATEST_TAG'. Expected format 'vMAJOR.MINOR.PATCH' (e.g., v1.2.3)." >&2
              exit 1
            fi

            # Ensure major is always 1
            MAJOR=1
          fi

          echo "Current version: $MAJOR.$MINOR.$PATCH"

          # Get the commit message (either from the last commit or PR title)
          COMMIT_MSG=$(git log -1 --pretty=%B)
          echo "Commit message: $COMMIT_MSG"

          # Determine version bump based on conventional commit prefix
          # feat: → bump minor
          # fix: → bump patch
          # feat! or fix! or BREAKING CHANGE: → bump minor (since major stays at 1)
          # chore:, docs:, style:, refactor:, test:, perf: → bump patch

          if echo "$COMMIT_MSG" | grep -qiE "^(feat!|fix!)"; then
            # Breaking change - bump minor (since major always stays at 1)
            MINOR=$((MINOR + 1))
            PATCH=0
            echo "Breaking change detected - bumping minor version"
          elif echo "$COMMIT_MSG" | grep -qiE "BREAKING CHANGE:"; then
            # Breaking change in body/footer - bump minor
            MINOR=$((MINOR + 1))
            PATCH=0
            echo "Breaking change detected in commit body - bumping minor version"
          elif echo "$COMMIT_MSG" | grep -qiE '^feat(\(.+\))?:'; then
            # Feature - bump minor
            MINOR=$((MINOR + 1))
            PATCH=0
            echo "Feature detected - bumping minor version"
          elif echo "$COMMIT_MSG" | grep -qiE '^(fix|chore|docs|style|refactor|test|perf)(\(.+\))?:'; then
            # Fix or other - bump patch
            PATCH=$((PATCH + 1))
            echo "Fix/patch detected - bumping patch version"
          else
            # Default to patch bump
            PATCH=$((PATCH + 1))
            echo "No conventional commit prefix detected - bumping patch version"
          fi

          NEW_VERSION="$MAJOR.$MINOR.$PATCH"

          # Handle pre-release
          # Automatic releases (push to main) are always pre-releases
          # Regular releases are only created via manual workflow trigger
          IS_PRERELEASE="false"
          if [ "${{ github.event_name }}" = "push" ]; then
            # Automatic release - always pre-release
            IS_PRERELEASE="true"
            PRERELEASE_TAG="alpha"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger
            if [ "${{ github.event.inputs.prerelease }}" = "true" ]; then
              IS_PRERELEASE="true"
              PRERELEASE_TAG="${{ github.event.inputs.prerelease_tag }}"
            else
              # Regular release via manual trigger
              IS_PRERELEASE="false"
            fi
          fi

          # Add pre-release suffix if needed
          if [ "$IS_PRERELEASE" = "true" ]; then
            # Find the highest pre-release number for this version
            PRERELEASE_NUM=1
            EXISTING_PRERELEASE=$(git tag -l "v${NEW_VERSION}-${PRERELEASE_TAG}.[0-9]*" | sort -V | tail -n 1)
            if [ -n "$EXISTING_PRERELEASE" ]; then
              # Extract the numeric suffix after the last dot (e.g., v1.2.3-alpha.4 -> 4)
              EXISTING_NUM="${EXISTING_PRERELEASE##*.}"
              if echo "$EXISTING_NUM" | grep -Eq '^[0-9]+$'; then
                PRERELEASE_NUM=$((EXISTING_NUM + 1))
              fi
            fi

            NEW_VERSION="${NEW_VERSION}-${PRERELEASE_TAG}.${PRERELEASE_NUM}"
            echo "Pre-release version: $NEW_VERSION"
          else
            echo "Regular release version: $NEW_VERSION"
          fi

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT

  build-and-publish:
    needs: calculate-version
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Update Assembly version
        uses: managedcode/MAUIAppVersion@v1
        with:
          csproj: 'src\TrackYourDay.MAUI\TrackYourDay.MAUI.csproj'
          version: ${{ github.run_number }}
          displayVersion: ${{ needs.calculate-version.outputs.version }}

      - name: Set up .NET Core
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Install MAUI workloads
        run: dotnet workload install maui

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release

      - name: Test
        run: dotnet test --configuration Release --logger "trx;LogFileName=test_results.xml" --filter "Category!=Integration"
        env:
          VSTEST_LOG_PATH: test_results.xml

      - name: Archive build output
        uses: thedoctor0/zip-release@0.7.1
        with:
          type: 'zip'
          directory: 'src\TrackYourDay.MAUI\bin\Release\net9.0-windows10.0.22000.0\win-x64'
          filename: 'TrackYourDay_v${{ needs.calculate-version.outputs.version }}.zip'
          exclusions: '*.git*'

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: 'src\TrackYourDay.MAUI\bin\Release\net9.0-windows10.0.22000.0\win-x64\TrackYourDay_v${{ needs.calculate-version.outputs.version }}.zip'
          artifactErrorsFailBuild: true
          prerelease: ${{ needs.calculate-version.outputs.is_prerelease }}
          tag: v${{ needs.calculate-version.outputs.version }}
          artifactContentType: application/zip
          body: |
            ## TrackYourDay v${{ needs.calculate-version.outputs.version }}

            This release was automatically created based on conventional commit messages.

            ### Installation
            1. Download the ZIP file below
            2. Extract to your local drive
            3. Run TrackYourDay.MAUI.exe

            For more information, see the [README](https://github.com/Skuty/TrackYourDay#readme).
